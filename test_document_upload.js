// üìÑ TEST UPLOAD DE DOCUMENTS - LABORANTIN
// üìÖ Cr√©√© le : 16 Ao√ªt 2025
// üéØ Tester l'upload et la gestion des documents par le personnel de laboratoire

const axios = require('axios');
const FormData = require('form-data');
const fs = require('fs');
const path = require('path');

const BASE_URL = 'http://localhost:3000/api';

// Couleurs pour les logs
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

// Variables globales pour les tests
let labStaffToken = null;
let patientId = null;
let documentId = null;

// ============================================================================
// FONCTIONS UTILITAIRES
// ============================================================================

/**
 * Cr√©er un fichier de test
 */
function createTestFile() {
  const testContent = `
RAPPORT D'ANALYSE M√âDICALE
========================

Patient: Test Patient
Date: ${new Date().toLocaleDateString('fr-FR')}
Laboratoire: BioTest Lab

R√âSULTATS:
- Glyc√©mie: 0.95 g/L (Normal: 0.70-1.10)
- Cholest√©rol total: 1.85 g/L (Normal: <2.00)
- HDL: 0.55 g/L (Normal: >0.40)
- LDL: 1.20 g/L (Normal: <1.60)

CONCLUSION:
Tous les param√®tres sont dans les normes.
Aucune anomalie d√©tect√©e.

Dr. Martin - Biologiste
  `;

  const testFilePath = path.join(__dirname, 'test_document.txt');
  fs.writeFileSync(testFilePath, testContent);
  return testFilePath;
}

/**
 * Supprimer le fichier de test
 */
function cleanupTestFile(filePath) {
  try {
    if (fs.existsSync(filePath)) {
      fs.unlinkSync(filePath);
      log('‚úÖ Fichier de test supprim√©', 'green');
    }
  } catch (error) {
    log(`‚ö†Ô∏è Erreur suppression fichier: ${error.message}`, 'yellow');
  }
}

// ============================================================================
// TESTS D'AUTHENTIFICATION
// ============================================================================

async function loginAsLabStaff() {
  try {
    log('\nüîê Connexion en tant que personnel de laboratoire...', 'cyan');
    
    const response = await axios.post(`${BASE_URL}/auth/login`, {
      email: 'tech1@biotest.fr',
      password: 'tech123'
    });

    if (response.data.success) {
      labStaffToken = response.data.data.token;
      log(`‚úÖ Connexion r√©ussie: ${response.data.data.user.first_name} ${response.data.data.user.last_name}`, 'green');
      log(`   R√¥le: ${response.data.data.user.role}`, 'blue');
      log(`   Laboratoire: ${response.data.data.user.laboratory?.name || 'Non d√©fini'}`, 'blue');
      return true;
    } else {
      log(`‚ùå √âchec connexion: ${response.data.message}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur connexion: ${error.response?.data?.message || error.message}`, 'red');
    return false;
  }
}

// ============================================================================
// TESTS GESTION DES PATIENTS
// ============================================================================

async function getLabPatients() {
  try {
    log('\nüë• R√©cup√©ration des patients du laboratoire...', 'cyan');
    
    const response = await axios.get(`${BASE_URL}/patients/lab`, {
      headers: { Authorization: `Bearer ${labStaffToken}` }
    });

    if (response.data.success) {
      const patients = response.data.data.patients;
      log(`‚úÖ ${patients.length} patients trouv√©s`, 'green');
      
      if (patients.length > 0) {
        patientId = patients[0].id;
        const patient = patients[0];
        log(`   Premier patient: ${patient.user.first_name} ${patient.user.last_name} (ID: ${patientId})`, 'blue');
        return true;
      } else {
        log('‚ö†Ô∏è Aucun patient trouv√©', 'yellow');
        return false;
      }
    } else {
      log(`‚ùå Erreur r√©cup√©ration patients: ${response.data.message}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur r√©cup√©ration patients: ${error.response?.data?.message || error.message}`, 'red');
    return false;
  }
}

async function searchPatients() {
  try {
    log('\nüîç Recherche de patients...', 'cyan');
    
    const response = await axios.get(`${BASE_URL}/patients/search?q=patient`, {
      headers: { Authorization: `Bearer ${labStaffToken}` }
    });

    if (response.data.success) {
      const patients = response.data.data.patients;
      log(`‚úÖ ${patients.length} patients trouv√©s avec la recherche "patient"`, 'green');
      
      patients.slice(0, 3).forEach(patient => {
        log(`   - ${patient.user.first_name} ${patient.user.last_name} (${patient.user.email})`, 'blue');
      });
      
      return true;
    } else {
      log(`‚ùå Erreur recherche patients: ${response.data.message}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur recherche patients: ${error.response?.data?.message || error.message}`, 'red');
    return false;
  }
}

// ============================================================================
// TESTS UPLOAD DE DOCUMENTS
// ============================================================================

async function uploadDocument() {
  try {
    log('\nüì§ Upload d\'un document...', 'cyan');
    
    if (!patientId) {
      log('‚ùå Aucun patient disponible pour l\'upload', 'red');
      return false;
    }

    // Cr√©er un fichier de test
    const testFilePath = createTestFile();
    
    // Pr√©parer le FormData
    const formData = new FormData();
    formData.append('file', fs.createReadStream(testFilePath));
    formData.append('patient_id', patientId.toString());
    formData.append('document_type', 'lab_result');
    formData.append('description', 'R√©sultats d\'analyses sanguines - Test automatis√©');

    const response = await axios.post(`${BASE_URL}/documents/upload`, formData, {
      headers: {
        Authorization: `Bearer ${labStaffToken}`,
        ...formData.getHeaders()
      }
    });

    // Nettoyer le fichier de test
    cleanupTestFile(testFilePath);

    if (response.data.success) {
      documentId = response.data.data.document.id;
      const doc = response.data.data.document;
      log(`‚úÖ Document upload√© avec succ√®s (ID: ${documentId})`, 'green');
      log(`   Nom: ${doc.filename}`, 'blue');
      log(`   Type: ${doc.document_type}`, 'blue');
      log(`   Taille: ${(doc.file_size / 1024).toFixed(2)} KB`, 'blue');
      log(`   Patient: ${doc.patient.user.first_name} ${doc.patient.user.last_name}`, 'blue');
      return true;
    } else {
      log(`‚ùå Erreur upload: ${response.data.message}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur upload: ${error.response?.data?.message || error.message}`, 'red');
    return false;
  }
}

// ============================================================================
// TESTS R√âCUP√âRATION DE DOCUMENTS
// ============================================================================

async function getPatientDocuments() {
  try {
    log('\nüìã R√©cup√©ration des documents du patient...', 'cyan');
    
    if (!patientId) {
      log('‚ùå Aucun patient disponible', 'red');
      return false;
    }

    const response = await axios.get(`${BASE_URL}/documents/patient/${patientId}`, {
      headers: { Authorization: `Bearer ${labStaffToken}` }
    });

    if (response.data.success) {
      const documents = response.data.data.documents;
      const patient = response.data.data.patient;
      
      log(`‚úÖ ${documents.length} documents trouv√©s pour ${patient.name}`, 'green');
      
      documents.forEach(doc => {
        log(`   - ${doc.filename} (${doc.document_type}) - ${new Date(doc.created_at).toLocaleDateString('fr-FR')}`, 'blue');
      });
      
      return true;
    } else {
      log(`‚ùå Erreur r√©cup√©ration documents: ${response.data.message}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur r√©cup√©ration documents: ${error.response?.data?.message || error.message}`, 'red');
    return false;
  }
}

async function viewDocument() {
  try {
    log('\nüëÅÔ∏è Test de visualisation du document...', 'cyan');
    
    if (!documentId) {
      log('‚ùå Aucun document disponible', 'red');
      return false;
    }

    const response = await axios.get(`${BASE_URL}/documents/${documentId}/view`, {
      headers: { Authorization: `Bearer ${labStaffToken}` },
      responseType: 'stream'
    });

    if (response.status === 200) {
      log(`‚úÖ Document accessible (Content-Type: ${response.headers['content-type']})`, 'green');
      log(`   Taille: ${response.headers['content-length']} bytes`, 'blue');
      return true;
    } else {
      log(`‚ùå Erreur visualisation: Status ${response.status}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur visualisation: ${error.response?.data?.message || error.message}`, 'red');
    return false;
  }
}

// ============================================================================
// TESTS DE SUPPRESSION
// ============================================================================

async function deleteDocument() {
  try {
    log('\nüóëÔ∏è Suppression du document de test...', 'cyan');
    
    if (!documentId) {
      log('‚ùå Aucun document √† supprimer', 'red');
      return false;
    }

    const response = await axios.delete(`${BASE_URL}/documents/${documentId}`, {
      headers: { Authorization: `Bearer ${labStaffToken}` }
    });

    if (response.data.success) {
      log(`‚úÖ Document supprim√© avec succ√®s`, 'green');
      return true;
    } else {
      log(`‚ùå Erreur suppression: ${response.data.message}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Erreur suppression: ${error.response?.data?.message || error.message}`, 'red');
    return false;
  }
}

// ============================================================================
// FONCTION PRINCIPALE
// ============================================================================

async function testDocumentManagement() {
  log('üß™ TESTS GESTION DES DOCUMENTS - PERSONNEL LABORATOIRE', 'bright');
  log('=' .repeat(60), 'bright');
  
  const startTime = Date.now();
  let successCount = 0;
  let totalTests = 0;

  const tests = [
    { name: 'Connexion personnel laboratoire', fn: loginAsLabStaff },
    { name: 'R√©cup√©ration patients laboratoire', fn: getLabPatients },
    { name: 'Recherche de patients', fn: searchPatients },
    { name: 'Upload de document', fn: uploadDocument },
    { name: 'R√©cup√©ration documents patient', fn: getPatientDocuments },
    { name: 'Visualisation de document', fn: viewDocument },
    { name: 'Suppression de document', fn: deleteDocument }
  ];

  for (const test of tests) {
    totalTests++;
    try {
      const success = await test.fn();
      if (success) {
        successCount++;
      }
    } catch (error) {
      log(`‚ùå Erreur inattendue dans ${test.name}: ${error.message}`, 'red');
    }
    
    // Pause entre les tests
    await new Promise(resolve => setTimeout(resolve, 500));
  }

  const endTime = Date.now();
  const duration = ((endTime - startTime) / 1000).toFixed(2);

  log('\n' + '=' .repeat(60), 'bright');
  log('üìä R√âSUM√â DES TESTS', 'bright');
  log('=' .repeat(60), 'bright');
  log(`‚úÖ Tests r√©ussis: ${successCount}/${totalTests}`, successCount === totalTests ? 'green' : 'yellow');
  log(`‚è±Ô∏è Dur√©e totale: ${duration}s`, 'blue');
  
  if (successCount === totalTests) {
    log('\nüéâ TOUS LES TESTS SONT PASS√âS !', 'green');
    log('‚úÖ La gestion des documents fonctionne parfaitement', 'green');
  } else {
    log(`\n‚ö†Ô∏è ${totalTests - successCount} test(s) ont √©chou√©`, 'yellow');
    log('üîß V√©rifiez les erreurs ci-dessus', 'yellow');
  }
}

// Lancer les tests
if (require.main === module) {
  testDocumentManagement().catch(error => {
    log(`üí• Erreur fatale: ${error.message}`, 'red');
    process.exit(1);
  });
}

module.exports = { testDocumentManagement };