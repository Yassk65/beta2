// üß™ TEST BACKEND MVP
// üìÖ Cr√©√© le : 11 Ao√ªt 2025
// üéØ Script de test pour v√©rifier le fonctionnement du backend

const axios = require('axios');

const BASE_URL = 'http://localhost:3000/api';

// ============================================================================
// CONFIGURATION DES TESTS
// ============================================================================

const testAccounts = {
  superAdmin: {
    email: 'admin@labresult.com',
    password: 'password'
  },
  hospitalAdmin: {
    email: 'admin@hopital-central.fr',
    password: 'password'
  },
  doctor: {
    email: 'dr.martin@hopital-central.fr',
    password: 'password'
  },
  labAdmin: {
    email: 'admin@biotest.fr',
    password: 'password'
  },
  technician: {
    email: 'tech1@biotest.fr',
    password: 'password'
  },
  patient: {
    email: 'patient1@example.com',
    password: 'password'
  }
};

let tokens = {};

// ============================================================================
// FONCTIONS UTILITAIRES
// ============================================================================

const log = (message, data = null) => {
  console.log(`\nüîç ${message}`);
  if (data) {
    console.log(JSON.stringify(data, null, 2));
  }
};

const logError = (message, error) => {
  console.error(`\n‚ùå ${message}`);
  if (error.response) {
    console.error(`Status: ${error.response.status}`);
    console.error(`Data:`, error.response.data);
  } else {
    console.error(error.message);
  }
};

const logSuccess = (message, data = null) => {
  console.log(`\n‚úÖ ${message}`);
  if (data) {
    console.log(JSON.stringify(data, null, 2));
  }
};

// ============================================================================
// TESTS D'AUTHENTIFICATION
// ============================================================================

async function testHealth() {
  try {
    log('Test de sant√© de l\'API...');
    const response = await axios.get(`${BASE_URL}/health`);
    logSuccess('API op√©rationnelle', response.data);
    return true;
  } catch (error) {
    logError('√âchec test de sant√©', error);
    return false;
  }
}

async function testLogin(accountType, credentials) {
  try {
    log(`Test de connexion ${accountType}...`);
    const response = await axios.post(`${BASE_URL}/auth/login`, credentials);
    
    if (response.data.success) {
      tokens[accountType] = response.data.data.token;
      logSuccess(`Connexion ${accountType} r√©ussie`, {
        user: response.data.data.user.email,
        role: response.data.data.user.role
      });
      return true;
    }
    return false;
  } catch (error) {
    logError(`√âchec connexion ${accountType}`, error);
    return false;
  }
}

async function testProfile(accountType) {
  try {
    log(`Test r√©cup√©ration profil ${accountType}...`);
    const response = await axios.get(`${BASE_URL}/auth/profile`, {
      headers: { Authorization: `Bearer ${tokens[accountType]}` }
    });
    
    if (response.data.success) {
      logSuccess(`Profil ${accountType} r√©cup√©r√©`, {
        email: response.data.data.user.email,
        role: response.data.data.user.role,
        hospital: response.data.data.user.hospital?.name,
        laboratory: response.data.data.user.laboratory?.name
      });
      return true;
    }
    return false;
  } catch (error) {
    logError(`√âchec r√©cup√©ration profil ${accountType}`, error);
    return false;
  }
}

async function testRegister() {
  try {
    log('Test inscription nouveau patient...');
    const newPatient = {
      email: `test.patient.${Date.now()}@example.com`,
      password: 'TestPassword123',
      first_name: 'Test',
      last_name: 'Patient',
      phone: '0612345678',
      date_of_birth: '1990-01-01',
      gender: 'M'
    };
    
    const response = await axios.post(`${BASE_URL}/auth/register`, newPatient);
    
    if (response.data.success) {
      logSuccess('Inscription r√©ussie', {
        email: response.data.data.user.email,
        role: response.data.data.user.role
      });
      return true;
    }
    return false;
  } catch (error) {
    logError('√âchec inscription', error);
    return false;
  }
}

// ============================================================================
// TESTS DES DONN√âES
// ============================================================================

async function testStats(accountType) {
  try {
    log(`Test statistiques ${accountType}...`);
    const response = await axios.get(`${BASE_URL}/users/stats`, {
      headers: { Authorization: `Bearer ${tokens[accountType]}` }
    });
    
    if (response.data.success) {
      logSuccess(`Statistiques ${accountType}`, response.data.data);
      return true;
    }
    return false;
  } catch (error) {
    logError(`√âchec statistiques ${accountType}`, error);
    return false;
  }
}

async function testHospitals() {
  try {
    log('Test liste des h√¥pitaux...');
    const response = await axios.get(`${BASE_URL}/users/hospitals`, {
      headers: { Authorization: `Bearer ${tokens.patient}` }
    });
    
    if (response.data.success) {
      logSuccess('Liste h√¥pitaux r√©cup√©r√©e', {
        count: response.data.data.hospitals.length,
        hospitals: response.data.data.hospitals.map(h => ({
          name: h.name,
          city: h.city,
          staff: h._count.users
        }))
      });
      return true;
    }
    return false;
  } catch (error) {
    logError('√âchec liste h√¥pitaux', error);
    return false;
  }
}

async function testLaboratories() {
  try {
    log('Test liste des laboratoires...');
    const response = await axios.get(`${BASE_URL}/users/laboratories`, {
      headers: { Authorization: `Bearer ${tokens.patient}` }
    });
    
    if (response.data.success) {
      logSuccess('Liste laboratoires r√©cup√©r√©e', {
        count: response.data.data.laboratories.length,
        laboratories: response.data.data.laboratories.map(l => ({
          name: l.name,
          city: l.city,
          staff: l._count.users
        }))
      });
      return true;
    }
    return false;
  } catch (error) {
    logError('√âchec liste laboratoires', error);
    return false;
  }
}

async function testNearby() {
  try {
    log('Test recherche par proximit√©...');
    const response = await axios.get(`${BASE_URL}/users/nearby`, {
      params: {
        lat: 48.8566,
        lng: 2.3522,
        radius: 50,
        type: 'both'
      },
      headers: { Authorization: `Bearer ${tokens.patient}` }
    });
    
    if (response.data.success) {
      logSuccess('Recherche proximit√© r√©ussie', {
        hospitals: response.data.data.hospitals?.length || 0,
        laboratories: response.data.data.laboratories?.length || 0
      });
      return true;
    }
    return false;
  } catch (error) {
    logError('√âchec recherche proximit√©', error);
    return false;
  }
}

// ============================================================================
// TESTS DE PERMISSIONS
// ============================================================================

async function testPermissions() {
  try {
    log('Test permissions - Patient tentant d\'acc√©der aux stats...');
    
    try {
      await axios.get(`${BASE_URL}/users/stats`, {
        headers: { Authorization: `Bearer ${tokens.patient}` }
      });
      logError('ERREUR: Patient a pu acc√©der aux stats !');
      return false;
    } catch (error) {
      if (error.response && error.response.status === 403) {
        logSuccess('Permissions correctes - Patient bloqu√© pour les stats');
        return true;
      } else {
        logError('Erreur inattendue lors du test permissions', error);
        return false;
      }
    }
  } catch (error) {
    logError('√âchec test permissions', error);
    return false;
  }
}

// ============================================================================
// EX√âCUTION DES TESTS
// ============================================================================

async function runAllTests() {
  console.log('üöÄ ================================');
  console.log('üß™ TESTS BACKEND MVP SANT√â');
  console.log('üöÄ ================================');
  
  const results = {
    passed: 0,
    failed: 0,
    total: 0
  };
  
  const runTest = async (testName, testFunction) => {
    results.total++;
    try {
      const success = await testFunction();
      if (success) {
        results.passed++;
        console.log(`\n‚úÖ ${testName} - R√âUSSI`);
      } else {
        results.failed++;
        console.log(`\n‚ùå ${testName} - √âCHEC`);
      }
    } catch (error) {
      results.failed++;
      console.log(`\n‚ùå ${testName} - ERREUR:`, error.message);
    }
  };
  
  // Tests de base
  await runTest('Sant√© API', testHealth);
  
  // Tests d'authentification
  await runTest('Connexion Super Admin', () => testLogin('superAdmin', testAccounts.superAdmin));
  await runTest('Connexion Admin H√¥pital', () => testLogin('hospitalAdmin', testAccounts.hospitalAdmin));
  await runTest('Connexion M√©decin', () => testLogin('doctor', testAccounts.doctor));
  await runTest('Connexion Admin Labo', () => testLogin('labAdmin', testAccounts.labAdmin));
  await runTest('Connexion Technicien', () => testLogin('technician', testAccounts.technician));
  await runTest('Connexion Patient', () => testLogin('patient', testAccounts.patient));
  
  // Tests de profils
  await runTest('Profil Super Admin', () => testProfile('superAdmin'));
  await runTest('Profil Patient', () => testProfile('patient'));
  
  // Test inscription
  await runTest('Inscription Nouveau Patient', testRegister);
  
  // Tests de donn√©es
  await runTest('Statistiques Super Admin', () => testStats('superAdmin'));
  await runTest('Statistiques Admin H√¥pital', () => testStats('hospitalAdmin'));
  await runTest('Liste H√¥pitaux', testHospitals);
  await runTest('Liste Laboratoires', testLaboratories);
  await runTest('Recherche Proximit√©', testNearby);
  
  // Tests de permissions
  await runTest('Test Permissions', testPermissions);
  
  // R√©sultats finaux
  console.log('\nüöÄ ================================');
  console.log('üìä R√âSULTATS DES TESTS');
  console.log('üöÄ ================================');
  console.log(`‚úÖ Tests r√©ussis: ${results.passed}`);
  console.log(`‚ùå Tests √©chou√©s: ${results.failed}`);
  console.log(`üìä Total: ${results.total}`);
  console.log(`üìà Taux de r√©ussite: ${Math.round((results.passed / results.total) * 100)}%`);
  
  if (results.failed === 0) {
    console.log('\nüéâ TOUS LES TESTS SONT PASS√âS !');
    console.log('üöÄ Backend MVP pr√™t pour le d√©veloppement !');
  } else {
    console.log(`\n‚ö†Ô∏è  ${results.failed} test(s) ont √©chou√©`);
    console.log('üîß V√©rifiez les erreurs ci-dessus');
  }
  
  return results.failed === 0;
}

// Ex√©cuter les tests si le script est appel√© directement
if (require.main === module) {
  runAllTests()
    .then((success) => {
      process.exit(success ? 0 : 1);
    })
    .catch((error) => {
      console.error('üí• Erreur fatale lors des tests:', error);
      process.exit(1);
    });
}

module.exports = { runAllTests };